#!/usr/bin/env ruby
# -*- ruby -*-

require "fileutils"

def site_dir
  File.expand_path(File.dirname(__FILE__) + "/../sitedir")
end

START_TAG = ";;; ++ emacs-starter-kit"
START_RE  = /^#{Regexp.quote(START_TAG)}/

END_TAG   = ";;; -- emacs-starter-kit"
END_RE    = /^#{Regexp.quote(END_TAG)}/

def dot_emacs(outs=STDOUT)
  outs.puts "#{START_TAG} -------------------------------------"
  outs.puts ";;; The following was automatically generated by the"
  outs.puts ";;; emacs-starter-kit"
  outs.puts "(setq load-path '(cons \"#{site_dir}\" load-path))"
  outs.puts "(require 'emacs-starter-kit)"
  outs.puts "#{END_TAG} -------------------------------------"
end

def install_dot_emacs
  dot_file = File.expand_path("~/.emacs")
  new_dot_file = File.expand_path("~/new-dot-emacs")
  open(dot_file) do |ins|
    open(new_dot_file, "w") do |outs|
      state = :copy
      while line = ins.gets
        case state
        when :copy_to_end
          outs.puts line
        when :copy
          if line =~ /^#{START_RE}/
            state = :skip
            dot_emacs(outs)
          else
            outs.puts line
          end
        when :skip
          if line =~ /^#{END_RE}/
            state = :copy_to_end
          end
        else
          outs.puts line
        end
      end
      dot_emacs(outs) if state == :copy
    end
  end
  FileUtils.mv dot_file, "#{dot_file}.orig"
  FileUtils.mv new_dot_file, dot_file
end

ESK_VERSION = '0.0.1'

if ARGV.empty?
  puts "Usage: esk (--sitedir|--version)"
  exit(0)
end

ARGV.each do |arg|
  case arg
  when '--sitedir'
    puts site_dir
  when '--emacs'
    dot_emacs
  when '--install'
    install_dot_emacs
  when '--version'
    puts ESK_VERSION
  else
    fail "Unknown options: #{arg}"
  end
end
